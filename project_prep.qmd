---
title: "Aliceblue_Project_Prep"
subtitle: "Data Preparation"
format: html
editor: visual
---

# Introduction

This document outlines the data engineering required to reconstruct and improve the visualisation of the heat map as shown in @fig-old-vis-on-poster, which depicts the monthly inflationary impact on key goods and services across each month in Singapore over 2023.

The code below requires the following packages:

```{r}
#| label: library
#| message: false

library(tidyverse)
library(ggplot2)
library(knitr)
library(dplyr)
library(readxl)
```

```{r}
#| label: fig-old-vis-on-poster
#| echo: false
#| fig.cap: "Heat map of inflationary impact on key items over 2023."

include_graphics("images/old_poster.png")
```

# Data Cleaning

The Straits Times based their visualisation on data published by the Singapore Department of Statistics (DOS). whereby the data in CSV format represents the CPI for each category of key goods and services with 2019 as the base year. The CSV file contains 15 separate sheets which cover average retail prices, CPI and year-on-year percent change in CPI across various time periods (annual, half-yearly, quarterly, and monthly) respectively.

However, with reference to @fig-old-vis-on-poster, only Sheet T11 *(Percent Change In Consumer Price Index (CPI) Over Corresponding Period Of Previous Year, 2019 As Base Year, Monthly)* will be used to accurately reflect the year-on-year data ordered by month as visualised in the heat map.

Relevant columns for data processing include:

-   `Variables`: Name of key items. These are separated into sub-categories such as "Food", "Clothing & Footwear", "Housing & Utilities", etc.

-   `Date columns`: These represent year-on-year CPI values for each Variable. The columns are named according to the corresponding year and month they represent, such as 2019 Jan, 2020 Jun, etc.

The following code loads the data from Sheet T11 in the CSV file, skipping the first 5 rows and removing any rows with NA values:

```{r}
#| label: load-data

# Load full data, select specific sheet (T11), skip first 5 rows and remove rows with NA values
data <- read_excel("cpiapr24.xlsx", sheet = "T11", skip = 5) |>
  filter(if_all(everything(), ~ !is.na(.)))

data
```

The data is filtered to include only the relevant variables so as to focus on the specific categories visualised on the heat map:

```{r}
#| label: filter-data-categories

# Filter the data to include only these categories
categories <- c(
        "Food",
        #  "Food Excl Food Serving Services", #  Temporary commented out
        "Clothing & Footwear",
        "Housing & Utilities",
        "Household Durables & Services",
        "Health Care",
        "Transport",
        "Communication",
        "Recreation & Culture",
        "Education"
        #  "Miscellaneous Goods & Services" #  Temporary commented out
)
```

The data is then filtered to include only data from the base year onwards (2019). This is done to narrow down the size of the dataset for easier management and faster performance, as well as to ensure the dataset's consistency with the base year:

```{r}
#| label: filter-data-date
 
# Filter the data to include only these categories and the months from 2019 onwards
data <- data |>
  filter(Variables %in% categories) |>
  select(Variables, starts_with(c("2019", "2020", "2021", "2022", "2023"))) |>
  # Convert selected columns to numeric
  mutate_at(vars(starts_with(c("2019", "2020", "2021", "2022", "2023"))), as.numeric)

# Print the filtered data
options(max.print = 1e6)
print(data, n = nrow(data), width = Inf)
```

```{r}
#| label: further-transform-data
# Create a month mapping
month_mapping <- c("Jan" = 1, "Feb" = 2, "Mar" = 3, "Apr" = 4, "May" = 5, "Jun" = 6,
                   "Jul" = 7, "Aug" = 8, "Sep" = 9, "Oct" = 10, "Nov" = 11, "Dec" = 12)

# Pivot the data frame
pivoted_data <- pivot_longer(
  data, 
  cols = starts_with(c("2019", "2020", "2021","2022", "2023")),
  names_to = "Month_Year",
  values_to = "Value"
) |>
  # Separate the Month column into Year and Month
  separate(Month_Year, into = c("Year", "Month"), sep = " ") |>
  # Convert Month column into numeric using mapping
  mutate(Year = as.numeric(Year), Month = month_mapping[Month]) |>
  # To sort the data by Year, then by Month
  arrange(Year, Month)

pivoted_data
```

# Attempting to plot the above data using a line graph    

```{r}

#| line-graph-plot

#  Maybe it's something to build upon?

# Convert Month and Year to a combined date variable for X-axis
pivoted_data$Date <- as.Date(paste(pivoted_data$Year, pivoted_data$Month, "01", sep = "-"))

pivoted_data

plt <- ggplot(pivoted_data, aes(x = Date, y = Value, color = Variables)) +
  geom_line(aes(color = Variables), alpha = 0.1, linetype="dotted") + #  add the exact line graph (harsh)
  geom_smooth(method = "auto", se = FALSE, aes(group = Variables)) +  # Add a smooth curve
  # geom_point(aes(color=Variables), alpha=0.2) + #  add the exact data point
  labs(
    title = "Inflation trend",
    x = "Date",
    y = "Value"
  ) +
  theme_minimal()

plt

```
# Attempting to plot a heatmap using the preprocessed above
```{r}

df_long <- 
  pivot_longer(data, cols = -Variables, names_to = "Month", values_to = "Value")
df_long


# Create a data frame for the year labels and vertical lines
years <- unique(df_long$Year)
year_positions <- seq(12.5, by = 12, length.out = length(years))

year_labels <- data.frame(
  Year = years,
  x_position = seq(6.5, by = 12, length.out = length(years))  # Adjust x_position for year labels
)

ggplot(df_long, aes(x = Month, y = Variables, fill = Value)) +
  geom_tile(color = "white") +
    scale_fill_gradient2(name = "Inflation Rate\nPercentage Change",
                       low = "red",  # Red (low end)
                       mid = "white",    # White (midpoint)
                       high = "blue", # blue (high end)
                       midpoint = 0,     # Set midpoint to 0
                       breaks = c(20, 10, 0, -7),  # Specify breaks
                       labels = c("20", "10", "0", "-7"),  # Specify labels
                       ) +
  labs(x = "Years", y = "Variables", title = "Heatmap of Variables by Month") +
  theme_minimal() +
  theme(legend.position = "top",  # Move legend to the top
        plot.title = element_text(hjust = 0.5),  # Center plot title
        axis.text.x = element_blank()  # Remove x-axis text
  ) +
  coord_fixed(ratio = 5) +  # Ensure square tiles
  geom_vline(xintercept = c(12.5, 24.5,36.5, 48.5, 60.5), linetype = "dashed", color = "black")   # Add vertical lines
  
```


# Conclusion
